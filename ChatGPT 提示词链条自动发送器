// ==UserScript==
// @name         ChatGPT æç¤ºè¯é“¾æ¡è‡ªåŠ¨å‘é€å™¨ - æç®€ç‰ˆ
// @namespace    http://tampermonkey.net/
// @version      3.0
// @description  æç®€é£æ ¼çš„ChatGPTæç¤ºè¯é“¾æ¡è‡ªåŠ¨å‘é€å™¨
// @author       You
// @match        https://chat.openai.com/*
// @match        https://chatgpt.com/*
// @grant        none
// ==/UserScript==

(function() {
  'use strict';

  // é…ç½®
  const CONFIG = {
    SEPARATOR: '---NEXT-PROMPT---',
    SEND_DELAY: 2000,
    MAX_WAIT: 300000,
    CHECK_INTERVAL: 1000
  };

  // é»˜è®¤æç¤ºè¯æ¨¡æ¿
  let PROMPTS = `è¯·åˆ†æä»¥ä¸‹å¤ç›˜æ—¥å¿—çš„èƒŒæ™¯å’Œæ ¸å¿ƒè¦ç´ ï¼š

{{INPUT}}

è¯·ä»ä»¥ä¸‹ç»´åº¦è¿›è¡Œåˆ†æï¼š
1. äº‹ä»¶èƒŒæ™¯å’Œèµ·å› 
2. å…³é”®å†³ç­–ç‚¹
3. æ‰§è¡Œè¿‡ç¨‹ä¸­çš„é—®é¢˜
4. ç»“æœå’Œå½±å“
5. ç»éªŒæ•™è®­

${CONFIG.SEPARATOR}

åŸºäºä¸Šè¿°åˆ†æï¼Œè¯·æä¾›3ä¸ªå…·ä½“çš„æ”¹è¿›æ–¹æ¡ˆï¼š

1. æµç¨‹ä¼˜åŒ–æ–¹æ¡ˆ
2. å†³ç­–æœºåˆ¶æ”¹è¿›æ–¹æ¡ˆ
3. é£é™©é¢„é˜²æ–¹æ¡ˆ

è¯·ä¸ºæ¯ä¸ªæ–¹æ¡ˆæä¾›ï¼š
- å…·ä½“å®æ–½æ­¥éª¤
- é¢„æœŸæ•ˆæœ
- å®æ–½éš¾åº¦è¯„ä¼°

${CONFIG.SEPARATOR}

è¯·è¯„ä¼°è¿™äº›æ”¹è¿›æ–¹æ¡ˆçš„å¯è¡Œæ€§ï¼Œå¹¶æ¨èæœ€ä½³æ–¹æ¡ˆï¼š

è€ƒè™‘å› ç´ ï¼š
- å®æ–½æˆæœ¬
- é¢„æœŸæ”¶ç›Š
- é£é™©ç¨‹åº¦
- ç»„ç»‡æ¥å—åº¦
- é•¿è¿œä»·å€¼

${CONFIG.SEPARATOR}

è¯·åˆ¶å®šè¯¦ç»†çš„å®æ–½è®¡åˆ’ï¼š

åŒ…æ‹¬ï¼š
- åˆ†é˜¶æ®µå®æ–½æ—¶é—´è¡¨
- æ‰€éœ€èµ„æºå’Œäººå‘˜
- å…³é”®é‡Œç¨‹ç¢‘å’Œæ£€æŸ¥ç‚¹
- é£é™©åº”å¯¹å’Œåº”æ€¥é¢„æ¡ˆ
- æˆåŠŸæŒ‡æ ‡å’Œè¯„ä¼°æ ‡å‡†

${CONFIG.SEPARATOR}

è¯·æ€»ç»“æœ¬æ¬¡åˆ†æçš„å…³é”®è¦ç‚¹ï¼š

1. æ ¸å¿ƒé—®é¢˜è¯†åˆ«
2. æœ€ä½³è§£å†³æ–¹æ¡ˆ
3. å®æ–½è¦ç‚¹
4. é¢„æœŸæˆæœ
5. åç»­è·Ÿè¿›å»ºè®®`;

  // çŠ¶æ€ç®¡ç†
  let state = {
    chain: [],
    input: '',
    index: 0,
    running: false
  };

  // å·¥å…·å‡½æ•°
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);
  
  const parseChain = (text) => text.split(CONFIG.SEPARATOR).map(p => p.trim()).filter(p => p);
  
  const replaceInput = (text) => text.replace(/\{\{INPUT\}\}/g, state.input);

  // DOM æ“ä½œ
  const findInput = () => $('textarea[data-id="root"]') || $('textarea[placeholder*="Message"]') || $('div[contenteditable="true"]');
  
  const findSendBtn = () => $('button[data-testid="send-button"]') || $('button[aria-label*="Send"]');
  
  const isGenerating = () => !!($('button[aria-label*="Stop"]') || $('button[data-testid="stop-button"]'));

  // æ ¸å¿ƒåŠŸèƒ½
  const sendMessage = async (text) => {
    const input = findInput();
    const btn = findSendBtn();
    
    if (!input || !btn) throw new Error('æœªæ‰¾åˆ°è¾“å…¥æ¡†æˆ–å‘é€æŒ‰é’®');
    
    const finalText = replaceInput(text);
    
    if (input.tagName === 'TEXTAREA') {
      input.value = finalText;
      input.dispatchEvent(new Event('input', { bubbles: true }));
    } else {
      input.textContent = finalText;
      input.dispatchEvent(new Event('input', { bubbles: true }));
    }
    
    await new Promise(resolve => setTimeout(resolve, 500));
    btn.click();
  };

  const waitResponse = () => new Promise((resolve, reject) => {
    const start = Date.now();
    const check = setInterval(() => {
      if (Date.now() - start > CONFIG.MAX_WAIT) {
        clearInterval(check);
        reject(new Error('ç­‰å¾…è¶…æ—¶'));
      }
      if (!isGenerating()) {
        clearInterval(check);
        resolve();
      }
    }, CONFIG.CHECK_INTERVAL);
  });

  const executeChain = async () => {
    if (state.running) return;
    if (!state.input && state.index === 0) {
      showInputModal();
      return;
    }
    
    state.running = true;
    updateUI();
    
    try {
      while (state.index < state.chain.length && state.running) {
        await sendMessage(state.chain[state.index]);
        await waitResponse();
        state.index++;
        updateUI();
        
        if (state.index < state.chain.length && state.running) {
          await new Promise(resolve => setTimeout(resolve, CONFIG.SEND_DELAY));
        }
      }
    } catch (error) {
      console.error('æ‰§è¡Œé”™è¯¯:', error);
      alert(`æ‰§è¡Œé”™è¯¯: ${error.message}`);
    } finally {
      state.running = false;
      updateUI();
    }
  };

  // UI åˆ›å»º
  const createPanel = () => {
    const panel = document.createElement('div');
    panel.innerHTML = `
      <div id="prompt-panel" style="
        position: fixed; top: 40px; right: 20px; width: 320px;
        background: #2d2d2d; color: white; padding: 15px;
        border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10000; font-family: Arial, sans-serif; font-size: 14px;
      ">
        <h3 style="margin: 0 0 15px 0; color: #4CAF50;">ğŸ¤– æ™ºèƒ½åˆ†æåŠ©æ‰‹</h3>
        
        <div style="margin-bottom: 15px;">
          <div>è¿›åº¦: <span id="progress">0/${state.chain.length}</span></div>
          <div>çŠ¶æ€: <span id="status">ç­‰å¾…è¾“å…¥</span></div>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <button id="btn-input" style="background: #FF5722; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">ğŸ“ è¾“å…¥æ•°æ®</button>
          <div style="display: flex; gap: 8px;">
            <button id="btn-start" style="background: #4CAF50; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; flex: 1;" disabled>å¼€å§‹</button>
            <button id="btn-from" style="background: #FF9800; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; flex: 1;">ä»ç¬¬Næ¡</button>
          </div>
          <div style="display: flex; gap: 8px;">
            <button id="btn-stop" style="background: #f44336; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; flex: 1;">åœæ­¢</button>
            <button id="btn-reset" style="background: #9E9E9E; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; flex: 1;">é‡ç½®</button>
          </div>
          <button id="btn-edit" style="background: #2196F3; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer;">ç¼–è¾‘æ¨¡æ¿</button>
        </div>
        
        <div style="margin-top: 15px; font-size: 12px; color: #888;">
          <div>è¾“å…¥çŠ¶æ€: <span id="input-status">æœªè¾“å…¥</span></div>
        </div>
      </div>
    `;
    
    document.body.appendChild(panel);
    bindEvents();
  };

  const showInputModal = () => {
    const modal = createModal(`
      <h3>ğŸ“ è¾“å…¥åˆ†ææ•°æ®</h3>
      <textarea id="input-text" style="width: 100%; height: 300px; background: #1a1a1a; color: white; border: 1px solid #555; border-radius: 5px; padding: 10px;" placeholder="è¯·è¾“å…¥è¦åˆ†æçš„å†…å®¹...">${state.input}</textarea>
      <div style="margin-top: 15px; text-align: right;">
        <button id="confirm-input" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">å¼€å§‹åˆ†æ</button>
        <button class="close-modal" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">å–æ¶ˆ</button>
      </div>
    `);
    
    $('#confirm-input').onclick = () => {
      state.input = $('#input-text').value.trim();
      if (!state.input) {
        alert('è¯·è¾“å…¥æ•°æ®ï¼');
        return;
      }
      $('#btn-start').disabled = false;
      updateUI();
      closeModal();
      executeChain();
    };
  };

  const showStartFromModal = () => {
    const modal = createModal(`
      <h3>ğŸ¯ é€‰æ‹©èµ·å§‹ä½ç½®</h3>
      <p>ä»ç¬¬å‡ æ¡å¼€å§‹ (1-${state.chain.length}):</p>
      <input type="number" id="start-index" min="1" max="${state.chain.length}" value="${state.index + 1}" style="width: 100%; padding: 10px; background: #1a1a1a; color: white; border: 1px solid #555; border-radius: 5px;">
      <div style="margin-top: 15px; text-align: right;">
        <button id="confirm-start" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">å¼€å§‹</button>
        <button class="close-modal" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">å–æ¶ˆ</button>
      </div>
    `);
    
    $('#confirm-start').onclick = () => {
      const index = parseInt($('#start-index').value) - 1;
      if (index >= 0 && index < state.chain.length) {
        state.index = index;
        updateUI();
        closeModal();
        executeChain();
      } else {
        alert('æ— æ•ˆçš„ç´¢å¼•');
      }
    };
  };

  const showEditModal = () => {
    const modal = createModal(`
      <h3>ğŸ“ ç¼–è¾‘æç¤ºè¯æ¨¡æ¿</h3>
      <p>ä½¿ç”¨ ${CONFIG.SEPARATOR} åˆ†éš”ä¸åŒæç¤ºè¯ï¼Œä½¿ç”¨ {{INPUT}} ä½œä¸ºå ä½ç¬¦</p>
      <textarea id="edit-prompts" style="width: 100%; height: 400px; background: #1a1a1a; color: white; border: 1px solid #555; border-radius: 5px; padding: 10px; font-family: monospace;">${PROMPTS}</textarea>
      <div style="margin-top: 15px; text-align: right;">
        <button id="save-prompts" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">ä¿å­˜</button>
        <button class="close-modal" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">å–æ¶ˆ</button>
      </div>
    `);
    
    $('#save-prompts').onclick = () => {
      PROMPTS = $('#edit-prompts').value;
      state.chain = parseChain(PROMPTS);
      updateUI();
      closeModal();
    };
  };

  const createModal = (content) => {
    const modal = document.createElement('div');
    modal.id = 'modal';
    modal.innerHTML = `
      <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 20000; display: flex; justify-content: center; align-items: center;">
        <div style="background: #2d2d2d; color: white; padding: 20px; border-radius: 10px; width: 80%; max-width: 600px;">
          ${content}
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // ç»‘å®šå…³é—­äº‹ä»¶
    $$('.close-modal').forEach(btn => btn.onclick = closeModal);
    modal.onclick = (e) => e.target === modal && closeModal();
    
    return modal;
  };

  const closeModal = () => {
    const modal = $('#modal');
    modal && document.body.removeChild(modal);
  };

  // äº‹ä»¶ç»‘å®š
  const bindEvents = () => {
    $('#btn-input').onclick = showInputModal;
    $('#btn-start').onclick = executeChain;
    $('#btn-from').onclick = showStartFromModal;
    $('#btn-stop').onclick = () => { state.running = false; updateUI(); };
    $('#btn-reset').onclick = () => { state.running = false; state.index = 0; updateUI(); };
    $('#btn-edit').onclick = showEditModal;
  };

  // UI æ›´æ–°
  const updateUI = () => {
    $('#progress').textContent = `${state.index}/${state.chain.length}`;
    $('#status').textContent = state.running ? 'è¿è¡Œä¸­...' : 
      state.index >= state.chain.length ? 'å·²å®Œæˆ' : 
      state.input ? 'å°±ç»ª' : 'ç­‰å¾…è¾“å…¥';
    $('#input-status').textContent = state.input ? 
      `å·²è¾“å…¥ ${state.input.length} å­—ç¬¦` : 'æœªè¾“å…¥';
  };

  // åˆå§‹åŒ–
  const init = () => {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
      return;
    }
    
    state.chain = parseChain(PROMPTS);
    createPanel();
    updateUI();
    
    console.log('ChatGPT æ™ºèƒ½åˆ†æåŠ©æ‰‹å·²åŠ è½½ (æç®€ç‰ˆ)');
  };

  init();
})();
