// ==UserScript==
// @name         ChatGPT æç¤ºè¯é“¾æ¡è‡ªåŠ¨å‘é€å™¨ - æ”¯æŒæŒ‡å®šèµ·å§‹ä½ç½®
// @namespace    http://tampermonkey.net/
// @version      2.3
// @description  è‡ªåŠ¨åŒ–å‘é€ChatGPTæç¤ºè¯é“¾æ¡ï¼Œæ”¯æŒåŠ¨æ€è¾“å…¥æ•°æ®å’ŒæŒ‡å®šèµ·å§‹ä½ç½®
// @author       You
// @match        https://chat.openai.com/*
// @match        https://chatgpt.com/*
// @grant        none
// ==/UserScript==

(function() {
  'use strict';

  // é…ç½®åŒºåŸŸ - ä½¿ç”¨åˆ†éš”ç¬¦æ¥åŒºåˆ†ä¸åŒçš„æç¤ºè¯
  const PROMPT_SEPARATOR = '---NEXT-PROMPT---';

  // é»˜è®¤æç¤ºè¯é“¾æ¡ï¼ˆä½¿ç”¨ {{INPUT}} ä½œä¸ºå ä½ç¬¦ï¼‰
  let PROMPT_CHAIN_TEXT = `è¯·åˆ†æä»¥ä¸‹å¤ç›˜æ—¥å¿—çš„èƒŒæ™¯å’Œæ ¸å¿ƒè¦ç´ ï¼š

{{INPUT}}

è¯·ä»ä»¥ä¸‹ç»´åº¦è¿›è¡Œåˆ†æï¼š
1. äº‹ä»¶èƒŒæ™¯å’Œèµ·å› 
2. å…³é”®å†³ç­–ç‚¹
3. æ‰§è¡Œè¿‡ç¨‹ä¸­çš„é—®é¢˜
4. ç»“æœå’Œå½±å“
5. ç»éªŒæ•™è®­

${PROMPT_SEPARATOR}

åŸºäºä¸Šè¿°åˆ†æï¼Œè¯·æä¾›3ä¸ªå…·ä½“çš„æ”¹è¿›æ–¹æ¡ˆï¼š

1. æµç¨‹ä¼˜åŒ–æ–¹æ¡ˆ
2. å†³ç­–æœºåˆ¶æ”¹è¿›æ–¹æ¡ˆ
3. é£é™©é¢„é˜²æ–¹æ¡ˆ

è¯·ä¸ºæ¯ä¸ªæ–¹æ¡ˆæä¾›ï¼š
- å…·ä½“å®æ–½æ­¥éª¤
- é¢„æœŸæ•ˆæœ
- å®æ–½éš¾åº¦è¯„ä¼°

${PROMPT_SEPARATOR}

è¯·è¯„ä¼°è¿™äº›æ”¹è¿›æ–¹æ¡ˆçš„å¯è¡Œæ€§ï¼Œå¹¶æ¨èæœ€ä½³æ–¹æ¡ˆï¼š

è€ƒè™‘å› ç´ ï¼š
- å®æ–½æˆæœ¬
- é¢„æœŸæ”¶ç›Š
- é£é™©ç¨‹åº¦
- ç»„ç»‡æ¥å—åº¦
- é•¿è¿œä»·å€¼

${PROMPT_SEPARATOR}

è¯·åˆ¶å®šè¯¦ç»†çš„å®æ–½è®¡åˆ’ï¼š

åŒ…æ‹¬ï¼š
- åˆ†é˜¶æ®µå®æ–½æ—¶é—´è¡¨
- æ‰€éœ€èµ„æºå’Œäººå‘˜
- å…³é”®é‡Œç¨‹ç¢‘å’Œæ£€æŸ¥ç‚¹
- é£é™©åº”å¯¹å’Œåº”æ€¥é¢„æ¡ˆ
- æˆåŠŸæŒ‡æ ‡å’Œè¯„ä¼°æ ‡å‡†

${PROMPT_SEPARATOR}

è¯·æ€»ç»“æœ¬æ¬¡åˆ†æçš„å…³é”®è¦ç‚¹ï¼š

1. æ ¸å¿ƒé—®é¢˜è¯†åˆ«
2. æœ€ä½³è§£å†³æ–¹æ¡ˆ
3. å®æ–½è¦ç‚¹
4. é¢„æœŸæˆæœ
5. åç»­è·Ÿè¿›å»ºè®®`;

  // é…ç½®é€‰é¡¹
  const CONFIG = {
      SEND_DELAY: 2000,        // å‘é€é—´éš”ï¼ˆæ¯«ç§’ï¼‰
      MAX_WAIT_TIME: 300000,   // æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼‰
      CHECK_INTERVAL: 1000     // æ£€æŸ¥é—´éš”ï¼ˆæ¯«ç§’ï¼‰
  };

  let currentIndex = 0;
  let isRunning = false;
  let controlPanel = null;
  let promptChain = [];
  let userInput = ''; // å­˜å‚¨ç”¨æˆ·è¾“å…¥çš„æ•°æ®

  // è§£ææç¤ºè¯é“¾æ¡
  function parsePromptChain(text) {
      return text.split(PROMPT_SEPARATOR)
                .map(prompt => prompt.trim())
                .filter(prompt => prompt.length > 0);
  }

  // åˆå§‹åŒ–æç¤ºè¯é“¾æ¡
  function initPromptChain() {
      promptChain = parsePromptChain(PROMPT_CHAIN_TEXT);
  }

  // æ›¿æ¢å ä½ç¬¦
  function replacePlaceholders(text, input) {
      return text.replace(/\{\{INPUT\}\}/g, input);
  }

  // åˆ›å»ºèµ·å§‹ä½ç½®é€‰æ‹©æ¨¡æ€æ¡†
  function createStartFromModal() {
      const modal = document.createElement('div');
      modal.id = 'start-from-modal';
      modal.innerHTML = `
          <div style="
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0,0,0,0.8);
              z-index: 20000;
              display: flex;
              justify-content: center;
              align-items: center;
          ">
              <div style="
                  background: #2d2d2d;
                  color: white;
                  padding: 25px;
                  border-radius: 10px;
                  width: 400px;
                  max-width: 90%;
              ">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                      <h3 style="margin: 0; color: #4CAF50;">ğŸ¯ é€‰æ‹©èµ·å§‹ä½ç½®</h3>
                      <button id="close-start-from" style="
                          background: transparent;
                          color: #888;
                          border: none;
                          font-size: 20px;
                          cursor: pointer;
                          padding: 0;
                          width: 30px;
                          height: 30px;
                      ">Ã—</button>
                  </div>

                  <div style="margin-bottom: 20px; font-size: 14px; color: #ccc;">
                      <p>ğŸ’¡ <strong>è¯´æ˜ï¼š</strong></p>
                      <p>é€‰æ‹©ä»ç¬¬å‡ æ¡æç¤ºè¯å¼€å§‹æ‰§è¡Œã€‚æ€»å…±æœ‰ <strong>${promptChain.length}</strong> æ¡æç¤ºè¯ã€‚</p>
                      <p style="color: #ff9800;">âš ï¸ æ³¨æ„ï¼šå¦‚æœè·³è¿‡ç¬¬1æ¡ï¼Œè¯·ç¡®ä¿ChatGPTå·²ç»æœ‰äº†åˆ†æçš„åŸºç¡€æ•°æ®ã€‚</p>
                  </div>

                  <div style="margin-bottom: 20px;">
                      <label style="display: block; margin-bottom: 10px; font-weight: bold;">ä»ç¬¬å‡ æ¡å¼€å§‹ï¼š</label>
                      <input type="number" id="start-index-input" min="1" max="${promptChain.length}" value="${currentIndex + 1}" style="
                          width: 100%;
                          padding: 10px;
                          border: 1px solid #555;
                          border-radius: 5px;
                          background: #1a1a1a;
                          color: white;
                          font-size: 16px;
                          text-align: center;
                      ">
                      <div style="margin-top: 5px; font-size: 12px; color: #888;">
                          èŒƒå›´: 1 - ${promptChain.length}
                      </div>
                  </div>

                  <div style="margin-bottom: 20px;">
                      <div style="font-size: 14px; color: #ccc; margin-bottom: 10px;"><strong>é¢„è§ˆé€‰ä¸­çš„æç¤ºè¯ï¼š</strong></div>
                      <div id="selected-prompt-preview" style="
                          background: #1a1a1a;
                          padding: 10px;
                          border-radius: 5px;
                          max-height: 150px;
                          overflow-y: auto;
                          font-family: monospace;
                          font-size: 12px;
                          white-space: pre-wrap;
                          border: 1px solid #555;
                      "></div>
                  </div>

                  <div style="display: flex; justify-content: space-between;">
                      <button id="confirm-start-from" style="
                          background: #4CAF50;
                          color: white;
                          border: none;
                          padding: 12px 24px;
                          border-radius: 5px;
                          cursor: pointer;
                          font-size: 16px;
                      ">ğŸš€ å¼€å§‹æ‰§è¡Œ</button>
                      <button id="cancel-start-from" style="
                          background: #666;
                          color: white;
                          border: none;
                          padding: 12px 24px;
                          border-radius: 5px;
                          cursor: pointer;
                      ">å–æ¶ˆ</button>
                  </div>
              </div>
          </div>
      `;

      document.body.appendChild(modal);
      return modal;
  }

  // åˆ›å»ºè¾“å…¥æ•°æ®æ¨¡æ€æ¡†
  function createInputModal() {
      const modal = document.createElement('div');
      modal.id = 'input-data-modal';
      modal.innerHTML = `
          <div style="
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0,0,0,0.8);
              z-index: 20000;
              display: flex;
              justify-content: center;
              align-items: center;
              padding: 20px;
              box-sizing: border-box;
          ">
              <div style="
                  background: #2d2d2d;
                  color: white;
                  padding: 20px;
                  border-radius: 10px;
                  width: 90%;
                  max-width: 800px;
                  height: 70%;
                  display: flex;
                  flex-direction: column;
              ">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                      <h3 style="margin: 0; color: #4CAF50;">ğŸ“ è¾“å…¥åˆ†ææ•°æ®</h3>
                      <button id="close-input-modal" style="
                          background: transparent;
                          color: #888;
                          border: none;
                          font-size: 20px;
                          cursor: pointer;
                          padding: 0;
                          width: 30px;
                          height: 30px;
                      ">Ã—</button>
                  </div>

                  <div style="margin-bottom: 15px; font-size: 14px; color: #ccc;">
                      <p>ğŸ’¡ <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong></p>
                      <ul style="margin: 5px 0; padding-left: 20px;">
                          <li>åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­ç²˜è´´ä½ çš„å¤ç›˜æ—¥å¿—ã€ä¼šè®®è®°å½•æˆ–å…¶ä»–éœ€è¦åˆ†æçš„æ–‡æœ¬</li>
                          <li>æ”¯æŒå¤šè¡Œæ–‡æœ¬å’Œæ ¼å¼</li>
                          <li>è¿™äº›å†…å®¹å°†æ›¿æ¢æç¤ºè¯ä¸­çš„ <code style="background: #444; padding: 2px 4px; border-radius: 3px;">{{INPUT}}</code> å ä½ç¬¦</li>
                          <li>è¾“å…¥å®Œæˆåç‚¹å‡»"å¼€å§‹åˆ†æ"æŒ‰é’®</li>
                      </ul>
                  </div>

                  <textarea id="input-data-textarea" style="
                      flex: 1;
                      min-height: 300px;
                      background: #1a1a1a;
                      color: white;
                      border: 1px solid #555;
                      border-radius: 5px;
                      padding: 15px;
                      font-size: 14px;
                      font-family: 'Consolas', 'Monaco', monospace;
                      resize: vertical;
                      outline: none;
                      line-height: 1.5;
                  " placeholder="è¯·åœ¨è¿™é‡Œè¾“å…¥ä½ çš„å¤ç›˜æ—¥å¿—ã€ä¼šè®®è®°å½•æˆ–å…¶ä»–éœ€è¦åˆ†æçš„å†…å®¹...

ä¾‹å¦‚ï¼š
é¡¹ç›®å¤ç›˜æ—¥å¿—ï¼š
æ—¶é—´ï¼š2024å¹´7æœˆ
é¡¹ç›®ï¼šXXXç³»ç»Ÿå‡çº§
å‚ä¸äººå‘˜ï¼šå¼ ä¸‰ã€æå››ã€ç‹äº”

èƒŒæ™¯ï¼š
ç”±äºä¸šåŠ¡éœ€æ±‚å¢é•¿ï¼Œç°æœ‰ç³»ç»Ÿæ€§èƒ½ä¸è¶³...

è¿‡ç¨‹ï¼š
1. éœ€æ±‚åˆ†æé˜¶æ®µ...
2. æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡...
3. å¼€å‘å®æ–½...

é—®é¢˜ï¼š
1. æ—¶é—´ä¼°ç®—ä¸å‡†ç¡®...
2. æ²Ÿé€šåè°ƒä¸å……åˆ†...

ç»“æœï¼š
é¡¹ç›®å»¶æœŸ2å‘¨ï¼Œä½†æœ€ç»ˆæˆåŠŸä¸Šçº¿..."></textarea>

                  <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                      <div style="font-size: 12px; color: #888;">
                          å­—ç¬¦æ•°: <span id="input-char-count">0</span>
                      </div>
                      <div>
                          <button id="start-analysis" style="
                              background: #4CAF50;
                              color: white;
                              border: none;
                              padding: 12px 24px;
                              border-radius: 5px;
                              cursor: pointer;
                              margin-right: 10px;
                              font-size: 16px;
                          ">ğŸš€ å¼€å§‹åˆ†æ</button>
                          <button id="cancel-input" style="
                              background: #666;
                              color: white;
                              border: none;
                              padding: 12px 24px;
                              border-radius: 5px;
                              cursor: pointer;
                          ">å–æ¶ˆ</button>
                      </div>
                  </div>
              </div>
          </div>
      `;

      document.body.appendChild(modal);
      return modal;
  }

  // åˆ›å»ºæ§åˆ¶é¢æ¿
  function createControlPanel() {
      const panel = document.createElement('div');
      panel.id = 'prompt-chain-panel';
      panel.innerHTML = `
          <div style="
              position: fixed;
              top: 20px;
              right: 20px;
              width: 420px;
              max-height: 85vh;
              background: #2d2d2d;
              color: white;
              padding: 15px;
              border-radius: 10px;
              box-shadow: 0 4px 20px rgba(0,0,0,0.3);
              z-index: 10000;
              font-family: Arial, sans-serif;
              font-size: 14px;
              overflow-y: auto;
          ">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                  <h3 style="margin: 0; color: #4CAF50;">ğŸ¤– æ™ºèƒ½åˆ†æåŠ©æ‰‹</h3>
                  <button id="toggle-panel" style="
                      background: transparent;
                      color: #888;
                      border: none;
                      font-size: 16px;
                      cursor: pointer;
                      padding: 2px 6px;
                  ">âˆ’</button>
              </div>

              <div id="panel-content">
                  <div style="margin-bottom: 10px;">
                      <strong>æ€»æç¤ºè¯æ•°:</strong> <span id="total-prompts">${promptChain.length}</span>
                  </div>

                  <div style="margin-bottom: 10px;">
                      <strong>å½“å‰è¿›åº¦:</strong> <span id="current-progress">0/${promptChain.length}</span>
                  </div>

                  <div style="margin-bottom: 15px;">
                      <strong>çŠ¶æ€:</strong> <span id="status">ç­‰å¾…è¾“å…¥æ•°æ®</span>
                  </div>

                  <div style="margin-bottom: 15px;">
                      <button id="input-data" style="
                          background: #FF5722;
                          color: white;
                          border: none;
                          padding: 12px 20px;
                          border-radius: 5px;
                          cursor: pointer;
                          width: 100%;
                          font-size: 16px;
                          margin-bottom: 10px;
                      ">ğŸ“ è¾“å…¥åˆ†ææ•°æ®</button>

                      <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                          <button id="start-chain" style="
                              background: #4CAF50;
                              color: white;
                              border: none;
                              padding: 8px 16px;
                              border-radius: 5px;
                              cursor: pointer;
                              flex: 1;
                          " disabled>å¼€å§‹åˆ†æ</button>

                          <button id="start-from" style="
                              background: #FF9800;
                              color: white;
                              border: none;
                              padding: 8px 16px;
                              border-radius: 5px;
                              cursor: pointer;
                              flex: 1;
                          ">ä»ç¬¬Næ¡å¼€å§‹</button>
                      </div>

                      <div style="display: flex; gap: 8px; margin-bottom: 5px;">
                          <button id="stop-chain" style="
                              background: #f44336;
                              color: white;
                              border: none;
                              padding: 8px 16px;
                              border-radius: 5px;
                              cursor: pointer;
                              flex: 1;
                          ">åœæ­¢</button>

                          <button id="reset-chain" style="
                              background: #9E9E9E;
                              color: white;
                              border: none;
                              padding: 8px 16px;
                              border-radius: 5px;
                              cursor: pointer;
                              flex: 1;
                          ">é‡ç½®</button>
                      </div>
                  </div>

                  <div style="margin-bottom: 15px;">
                      <button id="edit-prompts" style="
                          background: #2196F3;
                          color: white;
                          border: none;
                          padding: 10px 20px;
                          border-radius: 5px;
                          cursor: pointer;
                          width: 100%;
                          margin-bottom: 8px;
                      ">ğŸ“ ç¼–è¾‘æç¤ºè¯æ¨¡æ¿</button>

                      <button id="preview-prompts" style="
                          background: #9C27B0;
                          color: white;
                          border: none;
                          padding: 8px 16px;
                          border-radius: 5px;
                          cursor: pointer;
                          width: 100%;
                      ">ğŸ‘ï¸ é¢„è§ˆæç¤ºè¯</button>
                  </div>

                  <div style="font-size: 12px; color: #888;">
                      <div><strong>æ•°æ®çŠ¶æ€:</strong></div>
                      <div id="input-status" style="
                          background: #1a1a1a;
                          padding: 8px;
                          border-radius: 5px;
                          margin-top: 5px;
                          font-family: monospace;
                      ">æœªè¾“å…¥æ•°æ®</div>

                      <div style="margin-top: 10px;"><strong>ä¸‹ä¸€æ¡é¢„è§ˆ:</strong></div>
                      <div id="next-prompt" style="
                          background: #1a1a1a;
                          padding: 8px;
                          border-radius: 5px;
                          margin-top: 5px;
                          max-height: 100px;
                          overflow-y: auto;
                          white-space: pre-wrap;
                          font-family: monospace;
                      ">${promptChain[0] ? (promptChain[0].length > 200 ? promptChain[0].substring(0, 200) + '...' : promptChain[0]) : 'æ— '}</div>
                  </div>
              </div>
          </div>
      `;

      document.body.appendChild(panel);
      return panel;
  }

  // æ˜¾ç¤ºèµ·å§‹ä½ç½®é€‰æ‹©
  function showStartFromModal() {
      const modal = createStartFromModal();
      const input = document.getElementById('start-index-input');
      const preview = document.getElementById('selected-prompt-preview');

      // æ›´æ–°é¢„è§ˆ
      function updatePreview() {
          const index = parseInt(input.value) - 1;
          if (index >= 0 && index < promptChain.length) {
              const prompt = promptChain[index];
              const finalPrompt = userInput ? replacePlaceholders(prompt, userInput) : prompt;
              preview.textContent = finalPrompt.length > 500 ?
                  finalPrompt.substring(0, 500) + '...' : finalPrompt;
          } else {
              preview.textContent = 'æ— æ•ˆçš„ç´¢å¼•';
          }
      }

      // åˆå§‹é¢„è§ˆ
      updatePreview();

      // è¾“å…¥å˜åŒ–æ—¶æ›´æ–°é¢„è§ˆ
      input.addEventListener('input', updatePreview);

      // ç¡®è®¤æŒ‰é’®
      document.getElementById('confirm-start-from').addEventListener('click', () => {
          const startIndex = parseInt(input.value) - 1;
          if (startIndex >= 0 && startIndex < promptChain.length) {
              currentIndex = startIndex;
              updateStatus(`è®¾ç½®ä»ç¬¬ ${startIndex + 1} æ¡å¼€å§‹`, currentIndex);
              updateNextPromptPreview();

              // å…³é—­æ¨¡æ€æ¡†
              document.body.removeChild(modal);

              // å¼€å§‹æ‰§è¡Œ
              executeChain();
          } else {
              alert(`è¯·è¾“å…¥æœ‰æ•ˆçš„ç´¢å¼• (1-${promptChain.length})`);
          }
      });

      // å–æ¶ˆæŒ‰é’®
      document.getElementById('cancel-start-from').addEventListener('click', () => {
          document.body.removeChild(modal);
      });

      // å…³é—­æŒ‰é’®
      document.getElementById('close-start-from').addEventListener('click', () => {
          document.body.removeChild(modal);
      });

      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      modal.addEventListener('click', (e) => {
          if (e.target === modal) {
              document.body.removeChild(modal);
          }
      });
  }

  // æ˜¾ç¤ºè¾“å…¥æ•°æ®æ¨¡æ€æ¡†
  function showInputModal() {
      const modal = createInputModal();
      const textarea = document.getElementById('input-data-textarea');
      const countEl = document.getElementById('input-char-count');

      // å¦‚æœå·²æœ‰è¾“å…¥æ•°æ®ï¼Œæ˜¾ç¤ºå®ƒ
      if (userInput) {
          textarea.value = userInput;
      }

      // å®æ—¶æ›´æ–°å­—ç¬¦è®¡æ•°
      function updateCount() {
          countEl.textContent = textarea.value.length;
      }

      textarea.addEventListener('input', updateCount);
      updateCount();

      // å¼€å§‹åˆ†ææŒ‰é’®
      document.getElementById('start-analysis').addEventListener('click', () => {
          userInput = textarea.value.trim();
          if (!userInput) {
              alert('è¯·è¾“å…¥è¦åˆ†æçš„æ•°æ®ï¼');
              return;
          }

          // æ›´æ–°çŠ¶æ€
          updateInputStatus();
          document.getElementById('start-chain').disabled = false;
          updateStatus('æ•°æ®å·²è¾“å…¥ï¼Œå¯ä»¥å¼€å§‹åˆ†æ', 0);

          // å…³é—­æ¨¡æ€æ¡†
          document.body.removeChild(modal);

          // è‡ªåŠ¨å¼€å§‹æ‰§è¡Œ
          executeChain();
      });

      // å–æ¶ˆæŒ‰é’®
      document.getElementById('cancel-input').addEventListener('click', () => {
          document.body.removeChild(modal);
      });

      // å…³é—­æŒ‰é’®
      document.getElementById('close-input-modal').addEventListener('click', () => {
          document.body.removeChild(modal);
      });

      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      modal.addEventListener('click', (e) => {
          if (e.target === modal) {
              document.body.removeChild(modal);
          }
      });
  }

  // æ›´æ–°è¾“å…¥çŠ¶æ€æ˜¾ç¤º
  function updateInputStatus() {
      const statusEl = document.getElementById('input-status');
      if (statusEl) {
          if (userInput) {
              const preview = userInput.length > 100 ?
                  userInput.substring(0, 100) + '...' : userInput;
              statusEl.textContent = `å·²è¾“å…¥ ${userInput.length} å­—ç¬¦: ${preview}`;
          } else {
              statusEl.textContent = 'æœªè¾“å…¥æ•°æ®';
          }
      }
  }

  // æ›´æ–°ä¸‹ä¸€æ¡æç¤ºè¯é¢„è§ˆ
  function updateNextPromptPreview() {
      const nextPromptEl = document.getElementById('next-prompt');
      if (nextPromptEl) {
          const nextPrompt = promptChain[currentIndex] || 'é“¾æ¡å®Œæˆ';
          const finalPrompt = userInput ? replacePlaceholders(nextPrompt, userInput) : nextPrompt;
          nextPromptEl.textContent = finalPrompt.length > 200 ?
              finalPrompt.substring(0, 200) + '...' : finalPrompt;
      }
  }

  // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
  function updateStatus(status, progress = null) {
      const statusEl = document.getElementById('status');
      const progressEl = document.getElementById('current-progress');

      if (statusEl) statusEl.textContent = status;
      if (progressEl && progress !== null) {
          progressEl.textContent = `${progress}/${promptChain.length}`;
      }
      updateNextPromptPreview();
  }

  // æŸ¥æ‰¾è¾“å…¥æ¡†
  function findInputBox() {
      const selectors = [
          'textarea[data-id="root"]',
          'textarea[placeholder*="Message"]',
          'textarea[placeholder*="Send a message"]',
          '#prompt-textarea',
          'textarea[rows="1"]',
          'div[contenteditable="true"]'
      ];

      for (const selector of selectors) {
          const element = document.querySelector(selector);
          if (element) return element;
      }
      return null;
  }

  // æŸ¥æ‰¾å‘é€æŒ‰é’®
  function findSendButton() {
      const selectors = [
          'button[data-testid="send-button"]',
          'button[aria-label*="Send"]',
          'button svg[data-icon="send"]',
          'button:has(svg[data-icon="send"])',
          '[data-testid="send-button"]'
      ];

      for (const selector of selectors) {
          const element = document.querySelector(selector);
          if (element && !element.disabled) return element;
      }
      return null;
  }

  // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ç”Ÿæˆå›å¤
  function isGenerating() {
      const stopButton = document.querySelector('button[aria-label*="Stop"]') ||
                        document.querySelector('button[data-testid="stop-button"]') ||
                        document.querySelector('button:has(svg[data-icon="stop"])');

      if (stopButton) return true;

      const sendButton = findSendButton();
      return sendButton ? sendButton.disabled : false;
  }

  // å‘é€æ¶ˆæ¯
  function sendMessage(text) {
      return new Promise((resolve, reject) => {
          const inputBox = findInputBox();
          if (!inputBox) {
              reject(new Error('æ‰¾ä¸åˆ°è¾“å…¥æ¡†'));
              return;
          }

          // æ›¿æ¢å ä½ç¬¦
          const finalText = replacePlaceholders(text, userInput);

          // æ¸…ç©ºå¹¶è®¾ç½®æ–‡æœ¬
          if (inputBox.tagName === 'TEXTAREA') {
              inputBox.value = finalText;
              inputBox.dispatchEvent(new Event('input', { bubbles: true }));
          } else {
              inputBox.textContent = finalText;
              inputBox.dispatchEvent(new Event('input', { bubbles: true }));
          }

          setTimeout(() => {
              const sendButton = findSendButton();
              if (!sendButton || sendButton.disabled) {
                  reject(new Error('å‘é€æŒ‰é’®ä¸å¯ç”¨'));
                  return;
              }

              sendButton.click();
              resolve();
          }, 500);
      });
  }

  // ç­‰å¾…å›å¤å®Œæˆ
  function waitForResponse() {
      return new Promise((resolve, reject) => {
          const startTime = Date.now();

          const checkInterval = setInterval(() => {
              if (Date.now() - startTime > CONFIG.MAX_WAIT_TIME) {
                  clearInterval(checkInterval);
                  reject(new Error('ç­‰å¾…è¶…æ—¶'));
                  return;
              }

              if (!isGenerating()) {
                  clearInterval(checkInterval);
                  resolve();
              }
          }, CONFIG.CHECK_INTERVAL);
      });
  }

  // æ‰§è¡Œæç¤ºè¯é“¾æ¡
  async function executeChain() {
      if (isRunning) return;

      // å¦‚æœä»ç¬¬1æ¡å¼€å§‹ä¸”æ²¡æœ‰è¾“å…¥æ•°æ®ï¼Œè¦æ±‚è¾“å…¥
      if (currentIndex === 0 && !userInput.trim()) {
          alert('è¯·å…ˆè¾“å…¥åˆ†ææ•°æ®ï¼');
          showInputModal();
          return;
      }

      isRunning = true;
      updateStatus('è¿è¡Œä¸­...', currentIndex);

      try {
          while (currentIndex < promptChain.length && isRunning) {
              const prompt = promptChain[currentIndex];
              updateStatus(`å‘é€ç¬¬ ${currentIndex + 1} æ¡...`, currentIndex);

              await sendMessage(prompt);
              updateStatus(`ç­‰å¾…å›å¤ ${currentIndex + 1}...`, currentIndex);

              await waitForResponse();

              currentIndex++;
              updateStatus(`å®Œæˆç¬¬ ${currentIndex} æ¡`, currentIndex);

              if (currentIndex < promptChain.length && isRunning) {
                  await new Promise(resolve => setTimeout(resolve, CONFIG.SEND_DELAY));
              }
          }

          if (isRunning) {
              updateStatus('åˆ†æå®Œæˆï¼', currentIndex);
          }
      } catch (error) {
          updateStatus(`é”™è¯¯: ${error.message}`, currentIndex);
          console.error('æ‰§è¡Œé“¾æ¡æ—¶å‡ºé”™:', error);
      } finally {
          isRunning = false;
      }
  }

  // åœæ­¢æ‰§è¡Œ
  function stopChain() {
      isRunning = false;
      updateStatus('å·²åœæ­¢', currentIndex);
  }

  // é‡ç½®é“¾æ¡
  function resetChain() {
      stopChain();
      currentIndex = 0;
      updateStatus(userInput ? 'å·²é‡ç½®ï¼Œå¯ä»¥é‡æ–°å¼€å§‹' : 'ç­‰å¾…è¾“å…¥æ•°æ®', 0);
  }

    // åˆ›å»ºç¼–è¾‘å™¨æ¨¡æ€æ¡†
    function createEditorModal() {
        const modal = document.createElement('div');
        modal.id = 'prompt-editor-modal';
        modal.innerHTML = `
            <div style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 20000;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
                box-sizing: border-box;
            ">
                <div style="
                    background: #2d2d2d;
                    color: white;
                    padding: 20px;
                    border-radius: 10px;
                    width: 90%;
                    max-width: 1000px;
                    height: 85%;
                    display: flex;
                    flex-direction: column;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #4CAF50;">ç¼–è¾‘æç¤ºè¯æ¨¡æ¿</h3>
                        <button id="close-editor" style="
                            background: transparent;
                            color: #888;
                            border: none;
                            font-size: 20px;
                            cursor: pointer;
                            padding: 0;
                            width: 30px;
                            height: 30px;
                        ">Ã—</button>
                    </div>

                    <div style="margin-bottom: 15px; font-size: 14px; color: #ccc;">
                        <p>ğŸ“ <strong>ç¼–è¾‘è¯´æ˜ï¼š</strong></p>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>ä½¿ç”¨ <code style="background: #444; padding: 2px 4px; border-radius: 3px;">${PROMPT_SEPARATOR}</code> æ¥åˆ†éš”ä¸åŒçš„æç¤ºè¯</li>
                            <li>ä½¿ç”¨ <code style="background: #444; padding: 2px 4px; border-radius: 3px;">{{INPUT}}</code> ä½œä¸ºç”¨æˆ·è¾“å…¥æ•°æ®çš„å ä½ç¬¦</li>
                            <li>æ¯ä¸ªæç¤ºè¯å¯ä»¥åŒ…å«å¤šè¡Œå†…å®¹</li>
                            <li>æ”¯æŒæ¢è¡Œã€ç©ºè¡Œç­‰æ ¼å¼</li>
                        </ul>
                    </div>

                    <textarea id="prompt-editor-textarea" style="
                        flex: 1;
                        min-height: 300px;
                        background: #1a1a1a;
                        color: white;
                        border: 1px solid #555;
                        border-radius: 5px;
                        padding: 15px;
                        font-size: 14px;
                        font-family: 'Consolas', 'Monaco', monospace;
                        resize: vertical;
                        outline: none;
                        line-height: 1.5;
                    " placeholder="åœ¨è¿™é‡Œç¼–è¾‘ä½ çš„æç¤ºè¯æ¨¡æ¿...">${PROMPT_CHAIN_TEXT}</textarea>

                    <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 12px; color: #888;">
                            å½“å‰æç¤ºè¯æ•°é‡: <span id="editor-prompt-count">${promptChain.length}</span>
                        </div>
                        <div>
                            <button id="save-prompts" style="
                                background: #4CAF50;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 5px;
                                cursor: pointer;
                                margin-right: 10px;
                            ">ğŸ’¾ ä¿å­˜</button>
                            <button id="cancel-edit" style="
                                background: #666;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 5px;
                                cursor: pointer;
                            ">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        return modal;
    }

    // æ˜¾ç¤ºç¼–è¾‘å™¨
    function showEditor() {
        const modal = createEditorModal();
        const textarea = document.getElementById('prompt-editor-textarea');
        const countEl = document.getElementById('editor-prompt-count');

        // å®æ—¶æ›´æ–°è®¡æ•°
        function updateCount() {
            const count = parsePromptChain(textarea.value).length;
            countEl.textContent = count;
        }

        textarea.addEventListener('input', updateCount);

        // ä¿å­˜æŒ‰é’®
        document.getElementById('save-prompts').addEventListener('click', () => {
            PROMPT_CHAIN_TEXT = textarea.value;
            promptChain = parsePromptChain(PROMPT_CHAIN_TEXT);

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('total-prompts').textContent = promptChain.length;
            updateStatus('æ¨¡æ¿å·²æ›´æ–°', currentIndex);

            // å…³é—­æ¨¡æ€æ¡†
            document.body.removeChild(modal);
        });

        // å–æ¶ˆå’Œå…³é—­æŒ‰é’®
        document.getElementById('cancel-edit').addEventListener('click', () => {
            document.body.removeChild(modal);
        });

        document.getElementById('close-editor').addEventListener('click', () => {
            document.body.removeChild(modal);
        });

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        });
    }

    // æ˜¾ç¤ºé¢„è§ˆ
    function showPreview() {
        const modal = document.createElement('div');
        modal.id = 'prompt-preview-modal';
        modal.innerHTML = `
            <div style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 20000;
                display: flex;
                justify-content: center;
                align-items: center;
            ">
                <div style="
                    background: #2d2d2d;
                    color: white;
                    padding: 20px;
                    border-radius: 10px;
                    width: 80%;
                    max-width: 800px;
                    max-height: 80%;
                    display: flex;
                    flex-direction: column;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #4CAF50;">æç¤ºè¯é¢„è§ˆ</h3>
                        <button id="close-preview" style="
                            background: transparent;
                            color: #888;
                            border: none;
                            font-size: 20px;
                            cursor: pointer;
                            padding: 0;
                            width: 30px;
                            height: 30px;
                        ">Ã—</button>
                    </div>

                    <div id="preview-content" style="
                        flex: 1;
                        overflow-y: auto;
                        background: #1a1a1a;
                        padding: 15px;
                        border-radius: 5px;
                        font-family: 'Consolas', 'Monaco', monospace;
                        font-size: 14px;
                        line-height: 1.5;
                        white-space: pre-wrap;
                    "></div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        const content = document.getElementById('preview-content');
        let previewText = '';

        promptChain.forEach((prompt, index) => {
            const finalPrompt = userInput ? replacePlaceholders(prompt, userInput) : prompt;
            previewText += `=== ç¬¬ ${index + 1} æ¡æç¤ºè¯ ===\n\n${finalPrompt}\n\n`;
        });

        content.textContent = previewText;

        // å…³é—­æŒ‰é’®
        document.getElementById('close-preview').addEventListener('click', () => {
            document.body.removeChild(modal);
        });

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        });
    }

    // åˆ‡æ¢é¢æ¿æ˜¾ç¤º
    function togglePanel() {
        const content = document.getElementById('panel-content');
        const toggleBtn = document.getElementById('toggle-panel');

        if (content.style.display === 'none') {
            content.style.display = 'block';
            toggleBtn.textContent = 'âˆ’';
        } else {
            content.style.display = 'none';
            toggleBtn.textContent = '+';
        }
    }

    // åˆå§‹åŒ–
    function init() {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
            return;
        }

        // åˆå§‹åŒ–æç¤ºè¯é“¾æ¡
        initPromptChain();

        // åˆ›å»ºæ§åˆ¶é¢æ¿
        controlPanel = createControlPanel();

        // ç»‘å®šäº‹ä»¶
        document.getElementById('input-data').addEventListener('click', showInputModal);
        document.getElementById('start-chain').addEventListener('click', executeChain);
        document.getElementById('start-from').addEventListener('click', showStartFromModal);
        document.getElementById('stop-chain').addEventListener('click', stopChain);
        document.getElementById('reset-chain').addEventListener('click', resetChain);
        document.getElementById('edit-prompts').addEventListener('click', showEditor);
        document.getElementById('preview-prompts').addEventListener('click', showPreview);
        document.getElementById('toggle-panel').addEventListener('click', togglePanel);

        // åˆå§‹åŒ–çŠ¶æ€
        updateStatus('ç­‰å¾…è¾“å…¥æ•°æ®', 0);
        updateInputStatus();

        console.log('ChatGPT æ™ºèƒ½åˆ†æåŠ©æ‰‹å·²åŠ è½½');
    }

    // å¯åŠ¨
    init();
})();
